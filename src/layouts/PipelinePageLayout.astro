---
import PageLayout from '@layouts/PageLayout.astro';
import SubHeader from '@components/header/SubHeader.astro';
import TabBar from '@components/TabBar.astro';
import cache from 'bin/cache.js';

export interface Props {
    pipeline?: string;
    subtitle?: string | null;
    version?: string;
    versions?: string[];
    headings?: { text: string; slug: string; depth: number; fa_icon?: string }[];
    tabItems?: string[];
    md_github_url?: string;
}

const { pipeline, subtitle, headings, version, versions = [], tabItems = [], md_github_url = '' } = Astro.props;
const url = Astro.url.pathname.endsWith('/') ? Astro.url.pathname.slice(0, -1) : Astro.url.pathname;
const baseUrl = '/' + pipeline + '/' + version;
let allTabItems: { label: string; href: string; active: boolean; icon?: string }[] = [];

allTabItems = tabItems
    .filter((file) => file.split('/').length === 1)
    .map((file) => {
        return {
            label: file.replace(/-|_/g, ' ').replace(/\w\S*/g, (txt: string) => {
                return txt.charAt(0).toUpperCase() + txt.substring(1).toLowerCase();
            }),
            href: baseUrl + '/' + file + '/',
            active: url.includes(baseUrl + '/' + file),
            icon: tabItems.some((f) => f.startsWith(file + '/')) ? 'fa-regular fa-books' : '',
        };
    });
allTabItems.unshift({
    label: 'Introduction',
    href: `/${pipeline}/${version}/`,
    active: url === `/${pipeline}/${version}/`,
    icon: 'fa-solid fa-sign-in',
});
const latestVersion = versions[0];
const schema = await cache.get(`${pipeline}/${version}/nextflow_schema.json`);
if (schema !== undefined) {
    // Add the parameters tab if there is a schema to the second position
    allTabItems.splice(1, 0, {
        label: 'Parameters',
        href: `/${pipeline}/${version}/parameters/`,
        active: Astro.url.pathname.endsWith('/parameters/'),
        icon: 'fa-regular fa-list',
    });
}
if (version !== 'dev') {
    allTabItems.splice(1, 0, {
        label: 'Results',
        href: `/${pipeline}/${version}/results/`,
        active: url.includes(`/${pipeline}/${version}/results/`),
        icon: 'fa-brands fa-aws',
    });
}
const gh_url = 'https://github.com/nf-core/' + pipeline;
---

<PageLayout
    title={'nf-core/' + pipeline}
    subtitle={subtitle}
    mainpage_container={true}
    navTocHeadings={headings}
    md_github_url={md_github_url}
    subfooter={md_github_url !== ''}
>
    <SubHeader pipeline={pipeline} version={version} latestVersion={latestVersion} gh_url={gh_url} slot="sub-header" />
    {
        tabItems.length > 0 && (
            <TabBar items={allTabItems}>
                <div class="input-group input-group-sm justify-content-end justify-content-md-center">
                    <label class="input-group-text" for="version_select">
                        <i class="fas fa-tags" />
                    </label>
                    <div class="dropdown">
                        <button
                            class="btn btn-secondary dropdown-toggle rounded-start-0"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false"
                        >
                            {version}
                        </button>
                        <ul class="dropdown-menu  dropdown-menu-end w-100">
                            {versions.map((v) => {
                                let url = Astro.url.pathname.replace(`${pipeline}/${version}`, `${pipeline}/${v}`);
                                if (url.includes('/results/')) {
                                    url = `/${pipeline}/${v}/results/`;
                                }
                                return (
                                    <li>
                                        <a class={'dropdown-item ' + (v === version ? 'active' : '')} href={url}>
                                            {v}
                                        </a>
                                    </li>
                                );
                            })}
                        </ul>
                    </div>
                </div>
            </TabBar>
        )
    }

    <div>
        <slot />
    </div>
</PageLayout>
<style lang="scss"></style>
